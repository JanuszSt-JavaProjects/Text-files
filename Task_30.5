
CREATE TABLE STATS
(
    STAT_ID   INT(11) AUTO_INCREMENT PRIMARY KEY,
    STAT_DATE DATETIME    NOT NULL,
    STAT      VARCHAR(20) NOT NULL,
    VALUE     INT(11)     NOT NULL
);

CREATE VIEW BESTSELLERS_COUNT AS
SELECT COUNT(*) AS BEST_COUNT
FROM books
WHERE BESTSELLER = TRUE;


DELIMITER  $$
CREATE EVENT UPDATE_BESTSELLERS
    ON SCHEDULE EVERY 1 MINUTE
    DO
    BEGIN
        DECLARE BESTSELLERS_NUMBER INT;
        CALL UpdateBestSellers();

        SELECT BEST_COUNT
        FROM BESTSELLERS_COUNT
        INTO BESTSELLERS_NUMBER;

        INSERT INTO STATS (STAT_DATE, STAT, VALUE)
            VALUES (CURTIME(), "BESTSELLERS", BESTSELLERS_NUMBER);
    END $$
DELIMITER ;
